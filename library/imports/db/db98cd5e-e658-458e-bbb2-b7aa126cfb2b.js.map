{"version":3,"sources":["assets\\Script\\platform\\wx.js"],"names":["cc","Class","Component","properties","onLoad","sys","isNative","window","platform_wx","wx_flag_e","game","addPersistRootNode","node","AppID","AppSecret","androidPackageName","TOKEN_CODE_URL","USER_INFO_URL","REFRESH_TOKEN_URL","messFire","onfire","on","onPlatform","bind","url","xhr","XMLHttpRequest","onreadystatechange","readyState","status","result","JSON","parse","responseText","shareurl","shareUrl","open","send","start","update","dt","platform_opera","arguments","console","log","os","OS_IOS","ret","jsb","reflection","callStaticMethod","s","onDestroy","un","getAccessToken","code","self","response","msg","access_token","refresh_token","openid","platform_openid","expires_in","getUserInfo","platform_acc","platform_pwd","nickname","platform_name","platform_head","headimgurl","replace","city","country","sex","fire","platformResponse","undefined","find","getComponent"],"mappings":"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","sourceRoot":"/","sourcesContent":["cc.Class({\n    extends: cc.Component,\n\n    properties: {\n\n\n    },\n\n    onLoad () {\n        if (cc.sys.isNative){\n            window.platform_wx = true;\n            if (!window.wx_flag_e){\n                window.wx_flag_e = true;\n                cc.game.addPersistRootNode(this.node);\n            }\n            // this.AppID =  \"wx79ec924e452db83d\";\n            // this.AppSecret = \"509afff10023ccb38c46b5b0a127aa48\";\n            this.AppID =  \"wx45d424390f66b4ef\";\n            this.AppSecret = \"c5364c87cea56de25fe9e2514b236a14\";\n            this.androidPackageName = \"youme/playcity/game/wxapi/WXEntryActivity\";\n\n            var TOKEN_CODE_URL     = \"https://api.weixin.qq.com/sns/oauth2/access_token?appid=%s&secret=%s&code=%s&grant_type=authorization_code\";\n            var USER_INFO_URL      = \"https://api.weixin.qq.com/sns/userinfo?access_token=%s&openid=%s\";\n            var REFRESH_TOKEN_URL  = \"https://api.weixin.qq.com/sns/oauth2/refresh_token?appid=%s&grant_type=refresh_token&refresh_token=%s\"\n\n\n            this.messFire = onfire.on(\"onplatform\",this.onPlatform.bind(this));//监听第三方相关事件\n\n\n            var url = \"https://fangka.youmegame.cn/shareUrl.php\";\n            //var self = this;\n            var xhr = new XMLHttpRequest();\n            xhr.onreadystatechange = function () {\n                if (xhr.readyState == 4 && (xhr.status >= 200 && xhr.status < 400)) {\n                    var result = JSON.parse(xhr.responseText);\n                    window.shareurl = result.shareUrl;\n                }\n            };\n            xhr.open(\"GET\", url, true);\n            xhr.send();\n\n        }else{\n            //(console.log(\"yyyyyyyyyyyy\"));\n\n        }\n    },\n\n    start () {\n        //onfire.fire(\"onplatform\",\"login\",\"login\");\n    },\n    update (dt) {\n\n    },\n    onPlatform:function()//监听游戏中发起的第三方事件\n    {\n        window.platform_opera = arguments[0];\n        \n        console.log(window.platform_opera);\n        console.log(arguments[0]+\"--------\"+arguments[1]+\"--------\"+arguments[2]+\"--------\"+arguments[3]);\n        if (arguments[0] == \"init\")\n        {\n\n        }else if (arguments[0] == \"login\"){\n            if (cc.sys.isNative&&cc.sys.os==cc.sys.OS_IOS) {\n                let ret = jsb.reflection.callStaticMethod(\"AdMaster\",\"sendAuthRequest:title:\",\"1\",\"1\");\n            }else{\n                var s = jsb.reflection.callStaticMethod(\"org/cocos2dx/javascript/AppActivity\",\"sendAuthRequest\", \"()I\");\n            }\n            //console.log(s);\n        }else if (arguments[0] == \"share\")\n        {\n            if (cc.sys.isNative&&cc.sys.os==cc.sys.OS_IOS) {\n                let ret = jsb.reflection.callStaticMethod(\"AdMaster\",\"share:title:\",\"\",\"\");\n            }else{\n                var s = jsb.reflection.callStaticMethod(\"org/cocos2dx/javascript/AppActivity\",\"share\", \"()I\");\n            }\n        }else if (arguments[0] == \"openurl\"){\n\n        }else if (arguments[0] == \"shareurl\")\n        {\n            if (cc.sys.isNative && cc.sys.os == cc.sys.OS_IOS) {\n                let ret = jsb.reflection.callStaticMethod(\"AdMaster\", \"shareurl:cont:url:\", \n                arguments[1], arguments[2],arguments[3]);\n            } else {\n                var s = jsb.reflection.callStaticMethod(\"org/cocos2dx/javascript/AppActivity\", \"shareurl\", \"(Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;)I\", \n                    arguments[1], arguments[2],arguments[3]);\n            }\n        }\n    },\n\n\n\n    onDestroy:function()\n    {\n        if (cc.sys.isNative){\n            onfire.un(this.messFire);\n        }\n    },    \n\n\n\n    getAccessToken : function(code){        //获取accessToken\n        var url = \"https://api.weixin.qq.com/sns/oauth2/access_token?appid=\"\n        +this.AppID+\"&secret=\"+this.AppSecret+\"&code=\" + code + \"&grant_type=authorization_code\";\n        console.log(\"url=>>>> \"+url);\n        let self = this;\n        var xhr = new XMLHttpRequest();\n        xhr.onreadystatechange = function(){\n            if (xhr.readyState == 4 && (xhr.status >= 200 && xhr.status < 400)) {\n                var response = xhr.responseText;\n                console.log(\"response===>>>\",response);\n                var msg = JSON.parse(response);\n                var access_token = msg.access_token;\n                var refresh_token = msg.refresh_token;\n                var openid = msg.openid;\n                window.platform_openid = openid;\n                //如果超时进行重新刷新accessToken\n                if(msg.expires_in >= 7200){\n                    //刷新accesstoken\n                    // self.freshAccessToken(refresh_token).then(function(data){\n                    //    console.log(\"刷新accessToken 是\",data);\n                    //    access_token = data;\n                    self.getUserInfo(access_token,openid);\n                    //});\n                    //console.log(\"这个accessToken是刷新出来的token\",access_token);\n                }else{\n                    self.getUserInfo(access_token,openid);\n                }\n                \n            }\n        };\n        xhr.open(\"GET\",url,true);\n        xhr.send();\n    },\n    getUserInfo : function(access_token,openid){       //获取用户信息\n        console.log(\"accessToken is \" + access_token);\n        console.log(\"openid is \" + openid);\n        window.platform_acc = openid+\"\";\n        window.platform_pwd = \"wxpwd1\";\n        var url = \"https://api.weixin.qq.com/sns/userinfo?access_token=\"+access_token + \"&openid=\"+openid;\n        var self = this;\n        var xhr = new XMLHttpRequest();\n        xhr.onreadystatechange = function(){\n            if (xhr.readyState == 4 && (xhr.status >= 200 && xhr.status < 400)) {\n                var response = xhr.responseText;\n                console.log(\"response===>>>\",response);\n                var msg = JSON.parse(response);\n                console.log(\"msg is \" , msg);\n                console.log(\"nickName is \" + msg.nickname);\n                window.platform_name = msg.nickname;\n                window.platform_head = msg.headimgurl;\n                \n                window.platform_head = window.platform_head.replace(\"http:\",\"https:\");\n\n                console.log(\"city is \" + msg.city);\n                console.log(\"country \" + msg.country);\n                console.log(\"sex is  \" + msg.sex);\n\n                //cc.find(\"Canvas/com_Register\").active = true;\n                onfire.fire(\"onplatform_login\",window.platform_acc,window.platform_pwd);\n            }\n        };\n        xhr.open(\"GET\",url,true);\n        xhr.send();\n    \n    },\n\n});\n\nwindow.platformResponse = function()\n{\n    console.log(\"-----\");\n    console.log(arguments[0]);\n    if (arguments[0] != undefined){\n        cc.find(\"wx\").getComponent(\"wx\").getAccessToken(arguments[0]);\n    }\n}\n"]}