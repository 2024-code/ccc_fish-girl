{"version":3,"sources":["assets\\LaoHuJi\\module\\wheel\\wheel.js"],"names":["cc","Class","Component","properties","WheelIndex","tooltip","ItemHigh","LaunchDelay","StopDelay","MaxSpeed","LaunchInertia","StopInertia","GuiWeiShiJian","start","_isStop","_isDispatchEvent","_currentSpeed","_maxSpeed","_launchAcceleration","_stopAcceleration","_guiWeiSuDu","_itemNum","node","children","length","_validItemNum","_validItemTotalHigh","_itemArray","Array","i","getComponent","Sprite","_index_0_start","_index_1_start","_index_2_start","_index_0_end","_index_1_end","_index_2_end","_stopPosY","update","dt","y","move","Math","abs","thisFrameMove","DispatchEvent","eventCustom","Event","EventCustom","setUserData","dispatchEvent","Launch","unscheduleAllCallbacks","scheduleOnce","Stop","spriteFrame0","spriteFrame1","spriteFrame2","s","stopPosY","divisor","round","undefined","index_0","index_1","index_2","spriteFrame"],"mappings":"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","sourceRoot":"/","sourcesContent":["cc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        WheelIndex: {\r\n            default: 1,\r\n            tooltip: '第几个转轮（从1开始）',\r\n        },\r\n        ItemHigh: {\r\n            default: 0,\r\n            tooltip: '图标的高度',\r\n        },\r\n        LaunchDelay: {\r\n            default: 0.2,\r\n            tooltip: '响应启动命令的延迟时间',\r\n        },\r\n        StopDelay: {\r\n            default: 0.5,\r\n            tooltip: '响应制动命令的延迟时间',\r\n        },\r\n        MaxSpeed: {\r\n            default: 20,\r\n            tooltip: '一秒钟内闪过的图标的个数',\r\n        },\r\n        LaunchInertia: {\r\n            default: 5,\r\n            tooltip: '从静止加速到最大速度需要经过几个图标',\r\n        },\r\n        StopInertia: {\r\n            default: 5,\r\n            tooltip: '从最大速度减速到静止需要经过几个图标',\r\n        },\r\n        GuiWeiShiJian: {\r\n            default: 0.5,\r\n            tooltip: '图标归位需要的时间',\r\n        }\r\n    },\r\n\r\n    start: function () {\r\n        this._isStop = true;//标记当前运动状态\r\n        this._isDispatchEvent = false;//是否发送“Event_WhellStop”消息\r\n        this._currentSpeed = 0;  //当前的速度\r\n        this._maxSpeed = this.ItemHigh * this.MaxSpeed;  //最大速度\r\n        this._launchAcceleration = 0.5 * this._maxSpeed * this._maxSpeed / (this.LaunchInertia * this.ItemHigh);\r\n        this._stopAcceleration = 0.5 * this._maxSpeed * this._maxSpeed / (this.StopInertia * this.ItemHigh);\r\n        this._guiWeiSuDu = (this.ItemHigh * 0.5) / this.GuiWeiShiJian;\r\n        this._itemNum = this.node.children.length;\r\n        this._validItemNum = this._itemNum - 3;//（有效的图标个数 = 图标总数 - 3）减3的原因是可见的图标个数为3个\r\n        this._validItemTotalHigh = this._validItemNum * this.ItemHigh;//有效的图标的总高度\r\n        //图标数组\r\n        this._itemArray = new Array(this._itemNum);\r\n        for (var i = 0; i < this._itemNum; i++) {\r\n            this._itemArray[i] = this.node.children[i].getComponent(cc.Sprite);\r\n        }\r\n        //因为使用了一条直线来模拟一个圆周，为了保证旋转一圈时不穿帮，需要让直线首位接应\r\n        //可见的图标个数为3个，所以首部3个图标和尾部3个图标必须是是完全相同的\r\n        this._index_0_start = 0;\r\n        this._index_1_start = 1;\r\n        this._index_2_start = 2;\r\n        this._index_0_end = this._validItemNum + 0;\r\n        this._index_1_end = this._validItemNum + 1;\r\n        this._index_2_end = this._validItemNum + 2;\r\n        this._stopPosY = 0;//停在0点    \r\n    },\r\n\r\n    update: function (dt) {\r\n        if (this._isStop) {\r\n            if (this._currentSpeed > 0) {\r\n                //减速\r\n                this._currentSpeed -= this._stopAcceleration * dt;\r\n\r\n                this.node.y -= this._currentSpeed * dt;\r\n                //转了一轮\r\n                if (this.node.y < -this._validItemTotalHigh) {\r\n                    this.node.y += this._validItemTotalHigh;\r\n                }\r\n            }\r\n            else {\r\n                this._currentSpeed = 0;\r\n                //图标对齐\r\n                var move = this._stopPosY - this.node.y;//正负未知\r\n                if (move > 0.01 || move < -0.01) {//move太小证明两点重合\r\n                    if (Math.abs(move) > (this._validItemTotalHigh * 0.5))//补丁：修复在首尾接口处小概率可能出现的BUG\r\n                    {\r\n                        this.node.y += this._validItemTotalHigh;\r\n                        this._stopPosY = 0;\r\n                        move = this._stopPosY - this.node.y;\r\n                    }\r\n                    var thisFrameMove = this._guiWeiSuDu * dt;//正数\r\n                    if (thisFrameMove > Math.abs(move)) {\r\n                        thisFrameMove = move;//这次移动过后两点将重合\r\n                    }\r\n                    else if (move < 0) {\r\n                        thisFrameMove *= -1;\r\n                    }\r\n                    this.node.y += thisFrameMove;\r\n                }\r\n                else if (this._isDispatchEvent) {\r\n                    this.DispatchEvent();\r\n                    this._isDispatchEvent = false;\r\n                }\r\n            }\r\n        }\r\n        else {\r\n            if (this._currentSpeed < this._maxSpeed) {\r\n                //加速\r\n                this._currentSpeed += this._launchAcceleration * dt;\r\n            }\r\n            else {\r\n                //速度封顶\r\n                this._currentSpeed = this._maxSpeed;\r\n            }\r\n\r\n            this.node.y -= this._currentSpeed * dt;\r\n            //转了一轮\r\n            if (this.node.y < -this._validItemTotalHigh) {\r\n                this.node.y += this._validItemTotalHigh;\r\n            }\r\n        }\r\n    },\r\n\r\n    //投递事件\r\n    DispatchEvent: function () {\r\n        var eventCustom = new cc.Event.EventCustom('Event_WhellStop', true);\r\n        eventCustom.setUserData(this.WheelIndex);\r\n        this.node.dispatchEvent(eventCustom);\r\n    },\r\n\r\n    Launch: function () {\r\n        this.unscheduleAllCallbacks();\r\n        this.scheduleOnce(function () {\r\n            this._isStop = false;\r\n            this._isDispatchEvent = true;\r\n        }, this.LaunchDelay);\r\n    },\r\n\r\n    Stop: function (spriteFrame0, spriteFrame1, spriteFrame2) {\r\n        this.unscheduleAllCallbacks();\r\n        this.scheduleOnce(function () {\r\n            this._isStop = true;\r\n\r\n            var s = 0.5 * this._currentSpeed * this._currentSpeed / this._stopAcceleration;//以当前速度减速到0需要移动的距离\r\n            var stopPosY = this.node.y - s;//停在哪个点上\r\n            if (stopPosY < -this._validItemTotalHigh) {\r\n                stopPosY += this._validItemTotalHigh;\r\n            }\r\n            var divisor = Math.abs(stopPosY) / this.ItemHigh;\r\n            var round = Math.round(divisor);\r\n\r\n            this._stopPosY = -1 * round * this.ItemHigh;//记录一下最终会停在哪\r\n\r\n            if (spriteFrame0 != null      && spriteFrame1 != null      && spriteFrame2 != null &&\r\n                spriteFrame0 != undefined && spriteFrame1 != undefined && spriteFrame2 != undefined) {\r\n                //修改图标\r\n                var index_0 = round;\r\n                var index_1 = round + 1;\r\n                var index_2 = round + 2;\r\n\r\n                this._itemArray[index_0].spriteFrame = spriteFrame0;\r\n                this._itemArray[index_1].spriteFrame = spriteFrame1;\r\n                this._itemArray[index_2].spriteFrame = spriteFrame2;\r\n\r\n                //首尾图标保持一致\r\n                if (index_0 <= this._index_2_start) {\r\n                    this._itemArray[this._index_0_end].spriteFrame = this._itemArray[this._index_0_start].spriteFrame;\r\n                    this._itemArray[this._index_1_end].spriteFrame = this._itemArray[this._index_1_start].spriteFrame;\r\n                    this._itemArray[this._index_2_end].spriteFrame = this._itemArray[this._index_2_start].spriteFrame;\r\n                }\r\n                else if (index_2 >= this._index_0_end) {\r\n                    this._itemArray[this._index_0_start].spriteFrame = this._itemArray[this._index_0_end].spriteFrame;\r\n                    this._itemArray[this._index_1_start].spriteFrame = this._itemArray[this._index_1_end].spriteFrame;\r\n                    this._itemArray[this._index_2_start].spriteFrame = this._itemArray[this._index_2_end].spriteFrame;\r\n                }\r\n            }\r\n        }, this.StopDelay);\r\n    },\r\n});"]}