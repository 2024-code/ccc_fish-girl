{"version":3,"sources":["assets\\Script\\utils\\GameUpdate.js"],"names":["cc","Class","Component","properties","manifesttype","type","Asset","_updating","_canRetry","onLoad","gameArray","gameName","isChecking","playerInfo","require","getInstant","checkCb","event","log","getEventCode","jsb","EventAssetsManager","ERROR_NO_LOCAL_MANIFEST","ERROR_DOWNLOAD_MANIFEST","ERROR_PARSE_MANIFEST","ALREADY_UP_TO_DATE","index","localVersion","serverVersion","writeGameVersion_Function","game","restart","NEW_VERSION_FOUND","node","getComponent","com_UpdateMessageBox","active","getChildByName","progress","bg_Black","string","eventManager","removeListener","_checkListener","hotUpdate","updateCb","isFinished","isUpdate","UPDATE_PROGRESSION","checkUpdateTime","getDownloadedBytes","getTotalBytes","getMessage","UPDATE_FINISHED","checkUpdateTimeOut","UPDATE_FAILED","ERROR_UPDATING","ERROR_DECOMPRESS","_updateListener","paths","fileUtils","getSearchPaths","local_paths","_am","getLocalManifest","console","JSON","stringify","Array","prototype","unshift","sys","localStorage","setItem","setSearchPaths","audioEngine","stopAll","gameVersion","parse","getItem","retry","downloadFailedAssets","checkUpdate","isLoaded","EventListenerAssetsManager","bind","addListener","_failCount","update","versionA","versionB","checkGameUpdate_Function","gameMenuButtonClick_Function","path","getWritablePath","AssetsManager","manifestUrl","ENABLE_GC_FOR_NATIVE_OBJECTS","retain","self","setVersionCompareHandle","versionAList","split","versionBList","i","length","version_A","parseInt","version_B","size","setVerifyCallback","err","ret","compressed","md5","os","OS_ANDROID","setMaxConcurrentTask","version","callback","data","onDestroy","release"],"mappings":"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","sourceRoot":"/","sourcesContent":["/**\r\n * 游戏更新管理\r\n */\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        manifesttype: {\r\n            default: [],\r\n            type: cc.Asset\r\n        },\r\n        _updating: false,\r\n        _canRetry: false\r\n    },\r\n    onLoad: function() {\r\n        this.gameArray = [0, 0, 0, 0, 0, 0, 0, 0];\r\n        this.gameName = \"\";\r\n        this.isChecking = false;\r\n        this.playerInfo = require(\"PlayerInfo\").getInstant;\r\n    },\r\n    /**\r\n     * 检测版本\r\n     * @param {*} event \r\n     */\r\n    checkCb: function(event) {\r\n        cc.log(\"Code: \" + event.getEventCode());\r\n        switch (event.getEventCode()) \r\n        {\r\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\r\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\r\n                break;\r\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\r\n                var index = 1;\r\n                switch (this.gameName) {\r\n                case \"GrabBull\":\r\n                    this.gameArray[0] = 1;\r\n                    index = 1;\r\n                    break;\r\n                case \"Fish\":\r\n                    this.gameArray[1] = 1;\r\n                    index = 2;\r\n                    break;\r\n                case \"Bull\":\r\n                    this.gameArray[2] = 1;\r\n                    index = 3;\r\n                    break;\r\n                case \"Bde\":\r\n                    this.gameArray[3] = 1;\r\n                    index = 4;\r\n                    break;\r\n                case \"TwoEight\":\r\n                    this.gameArray[4] = 1;\r\n                    index = 5;\r\n                    break;\r\n                case \"LineGame\":\r\n                    this.gameArray[5] = 1;\r\n                    index = 6;\r\n                    break;\r\n                case \"Land\":\r\n                    this.gameArray[6] = 1;\r\n                    index = 7;\r\n                    break;\r\n                }\r\n                this.playerInfo.localVersion[index] = this.serverVersion;\r\n                cc.log(this.serverVersion);\r\n                cc.log(this.playerInfo.localVersion);\r\n                this.writeGameVersion_Function(this.playerInfo.localVersion,function() {\r\n                    cc.game.restart();\r\n                });\r\n                this._updating = false;\r\n                break;\r\n            case jsb.EventAssetsManager.NEW_VERSION_FOUND:\r\n                this.node.getComponent(\"LobbyMain\").com_UpdateMessageBox.active = true;\r\n                this.node.getComponent(\"LobbyMain\").com_UpdateMessageBox.getChildByName(\"pb_Loading\").getComponent(\"cc.ProgressBar\").progress = 0;\r\n                this.node.getComponent(\"LobbyMain\").com_UpdateMessageBox.getChildByName(\"pb_Loading\").active = true;\r\n                this.node.getComponent(\"LobbyMain\").bg_Black.active = true;\r\n                this.node.getComponent(\"LobbyMain\").com_UpdateMessageBox.getChildByName(\"lb_Tips\").getComponent(\"cc.Label\").string = \"游戏需要更新到 \" + this.serverVersion + \" 版本\";\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n        cc.eventManager.removeListener(this._checkListener);\r\n        this._checkListener = null;\r\n        this._updating = false;\r\n        this.hotUpdate();\r\n    },\r\n\r\n    /**\r\n     * 更新版本\r\n     * @param {*} event \r\n     */\r\n    updateCb: function(event) {\r\n        //是否更新完成\r\n        var isFinished = false;\r\n        //是否需要更新\r\n        var isUpdate = false;\r\n        switch (event.getEventCode()) \r\n        {\r\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\r\n                isUpdate = true;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_PROGRESSION:\r\n                this.node.getComponent(\"LobbyMain\").checkUpdateTime = 20;\r\n                this.node.getComponent(\"LobbyMain\").com_UpdateMessageBox.getChildByName(\"pb_Loading\").active = true;\r\n                this.node.getComponent(\"LobbyMain\").com_UpdateMessageBox.getChildByName(\"pb_Loading\").getComponent(\"cc.ProgressBar\").progress = event.getDownloadedBytes() / event.getTotalBytes();\r\n                event.getMessage();\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\r\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\r\n                isUpdate = true;\r\n                break;\r\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\r\n                cc.log(\"已是最新版本\");\r\n                this._updating = false;\r\n                isUpdate = true;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_FINISHED:\r\n                cc.log(\"更新完成\");\r\n                this.node.getComponent(\"LobbyMain\").checkUpdateTimeOut = false;\r\n                this.node.getComponent(\"LobbyMain\").com_UpdateMessageBox.getChildByName(\"pb_Loading\").active = true;\r\n                this.node.getComponent(\"LobbyMain\").com_UpdateMessageBox.getChildByName(\"pb_Loading\").getComponent(\"cc.ProgressBar\").progress = 1;\r\n                isFinished = true;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_FAILED:\r\n                this._updating = false;\r\n                this._canRetry = true;\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_UPDATING:\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DECOMPRESS:\r\n                break;\r\n        }\r\n        if(isUpdate)\r\n        {\r\n            cc.eventManager.removeListener(this._updateListener);\r\n            this._updateListener = null;\r\n            this._updating = false;\r\n        }\r\n        if (isFinished) \r\n        {\r\n            cc.eventManager.removeListener(this._updateListener);\r\n            this._updateListener = null;\r\n            var paths = jsb.fileUtils.getSearchPaths();\r\n            var local_paths = this._am.getLocalManifest().getSearchPaths();\r\n            console.log(JSON.stringify(local_paths));\r\n            Array.prototype.unshift(paths, local_paths);\r\n            cc.sys.localStorage.setItem(\"HotUpdateSearchPaths\", JSON.stringify(paths));\r\n            jsb.fileUtils.setSearchPaths(paths);\r\n            cc.audioEngine.stopAll();\r\n            var index = 0;\r\n            switch (this.gameName) {\r\n            case \"GrabBull\":\r\n                this.gameArray[0] = 1;\r\n                index = 1;\r\n                break;\r\n            case \"Fish\":\r\n                this.gameArray[1] = 1;\r\n                index = 2;\r\n                break;\r\n            case \"Bull\":\r\n                this.gameArray[2] = 1;\r\n                index = 3;\r\n                break;\r\n            case \"Bde\":\r\n                this.gameArray[3] = 1;\r\n                index = 4;\r\n                break;\r\n            case \"TwoEight\":\r\n                this.gameArray[4] = 1;\r\n                index = 5;\r\n                break;\r\n            case \"LineGame\":\r\n                this.gameArray[5] = 1;\r\n                index = 6;\r\n                break;\r\n            case \"Land\":\r\n                this.gameArray[6] = 1;\r\n                index = 7\r\n            }\r\n            var gameVersion = JSON.parse(cc.sys.localStorage.getItem(\"gameVersion\"));\r\n            this.node.getComponent(\"LobbyMain\").com_UpdateMessageBox.getChildByName(\"pb_Loading\").active = true;\r\n            this.node.getComponent(\"LobbyMain\").com_UpdateMessageBox.getChildByName(\"pb_Loading\").getComponent(\"cc.ProgressBar\").progress = 1;\r\n            if(gameVersion !== null)\r\n            {\r\n                this.playerInfo.localVersion[index] = this.serverVersion;\r\n                this.writeGameVersion_Function(this.playerInfo.localVersion,function() {\r\n                    cc.game.restart();\r\n                });\r\n            }\r\n        }\r\n    },\r\n    /**\r\n     * 重试\r\n     */\r\n    retry: function() { \r\n        if(!this._updating && this._canRetry)\r\n        {\r\n            this._canRetry = false, this._am.downloadFailedAssets();\r\n        }\r\n    },\r\n\r\n    /**\r\n     * 检测更新\r\n     */\r\n    checkUpdate: function() {\r\n        if(this._updating || this._am.getLocalManifest().isLoaded())\r\n        {\r\n            this._checkListener = new jsb.EventListenerAssetsManager(this._am, this.checkCb.bind(this));\r\n            cc.eventManager.addListener(this._checkListener, 1);\r\n            this._am.checkUpdate();\r\n            this._updating = true;\r\n        }\r\n    },\r\n\r\n    /**\r\n     * 热更新\r\n     */\r\n    hotUpdate: function() {\r\n        this._updateListener = new jsb.EventListenerAssetsManager(this._am, this.updateCb.bind(this));\r\n        cc.eventManager.addListener(this._updateListener, 1);\r\n        this._failCount = 0;\r\n        this._am.update();\r\n        this.versionA === this.versionB ? this._updating = false : this._updating = true;\r\n    },\r\n\r\n    /**\r\n     * \r\n     * @param {*} gameName \r\n     */\r\n    checkGameUpdate_Function: function(gameName) {\r\n        this.node.getComponent(\"LobbyMain\").com_UpdateMessageBox.getChildByName(\"lb_Tips\").getComponent(\"cc.Label\").string = gameName;\r\n        var index = 0;\r\n        switch (gameName) \r\n        {\r\n            case \"GrabBull\":\r\n                index = 0;\r\n                break;\r\n            case \"Fish\":\r\n                index = 1;\r\n                break;\r\n            case \"Bull\":\r\n                index = 2;\r\n                break;\r\n            case \"Bde\":\r\n                index = 3;\r\n                break;\r\n            case \"TwoEight\":\r\n                index = 4;\r\n                break;\r\n            case \"LineGame\":\r\n                index = 5;\r\n                break;\r\n            case \"Land\":\r\n                index = 6;\r\n                break;\r\n            case \"Runing\":\r\n                index = 7;\r\n                break;\r\n        }\r\n        this.node.getComponent(\"LobbyMain\").com_UpdateMessageBox.getChildByName(\"lb_Tips\").getComponent(\"cc.Label\").string = index;\r\n        this.gameName = gameName;\r\n        this.node.getComponent(\"LobbyMain\").com_UpdateMessageBox.getChildByName(\"lb_Tips\").getComponent(\"cc.Label\").string = this.gameName;\r\n\r\n        if (this.gameArray[index])\r\n        {\r\n            if(this.gameName == \"LineGame\")\r\n            {\r\n                //this.node.getComponent(\"LobbyMain\").loginGameRoom_Function(this.node.getComponent(\"LobbyMain\").com_GameMenu.getChildByName(\"LineGame\").getComponent(\"LobbyButtonClick\"), \"LineGame\");\r\n            }\r\n            else\r\n            {\r\n                this.node.getComponent(\"LobbyMain\").gameMenuButtonClick_Function(\"com_\" + this.gameName);\r\n                this.node.getComponent(\"LobbyMain\").bg_Black.active = false;\r\n                this.node.getComponent(\"LobbyMain\").com_UpdateMessageBox.active = false;\r\n                this.node.getComponent(\"LobbyMain\").com_UpdateMessageBox.getChildByName(\"pb_Loading\").getComponent(\"cc.ProgressBar\").progress = 1;\r\n            }\r\n        }\r\n        else \r\n        {\r\n            var path = (jsb.fileUtils ? jsb.fileUtils.getWritablePath() : \"/\") + gameName;\r\n            //cc.log(path);\r\n            this._am = new jsb.AssetsManager(this.manifestUrl[index], path);\r\n            cc.sys.ENABLE_GC_FOR_NATIVE_OBJECTS || this._am.retain();\r\n            //cc.log(index);\r\n            var self = this;\r\n            this.serverVersion = 0;\r\n            this.node.getComponent(\"LobbyMain\").com_UpdateMessageBox.getChildByName(\"lb_Tips\").getComponent(\"cc.Label\").string = \"获取版本号...\";\r\n            //检测版本\r\n            this._am.setVersionCompareHandle(function(versionA, versionB) {\r\n                self.serverVersion = versionB;\r\n                cc.log(\"JS Custom Version Compare: version A is \" + versionA + \", version B is \" + versionB);\r\n                self.node.getComponent(\"LobbyMain\").checkUpdateTimeOut = true;\r\n                var versionAList = versionA.split(\".\");\r\n                var versionBList = versionB.split(\".\");\r\n                for (var i = 0; i < versionAList.length; i++) \r\n                {\r\n                    var version_A = parseInt(versionAList[i]);\r\n                    var version_B = parseInt(versionBList[i] || 0);\r\n                    if (version_A !== version_B)\r\n                    {\r\n                        return - 1;\r\n                    }\r\n                }\r\n                if(versionBList.length != versionAList.length)\r\n                {\r\n                    return -1;\r\n                }\r\n                else\r\n                {\r\n                    self._updating = false;\r\n                    return 0;\r\n                }\r\n            });\r\n            this.size = 0;\r\n            this._am.setVerifyCallback(function(err, ret) {\r\n                ret.compressed,\r\n                ret.md5,\r\n                ret.path;\r\n                return self.size = ret.size,\r\n                true\r\n            });\r\n            if(cc.sys.os === cc.sys.OS_ANDROID)\r\n            {\r\n                this._am.setMaxConcurrentTask(1);\r\n            }\r\n            this.checkUpdate();\r\n        }\r\n    },\r\n\r\n    /**\r\n     * 将游戏版本写入缓存数据\r\n     * @param {*} version \r\n     * @param {*} callback \r\n     */\r\n    writeGameVersion_Function: function(version, callback) {\r\n        var data = null;\r\n        data = {\r\n            gameVersion: version\r\n        },\r\n        cc.sys.localStorage.setItem(\"gameVersion\", JSON.stringify(data));\r\n        callback && callback();\r\n    },\r\n\r\n    /**\r\n     * 销毁\r\n     */\r\n    onDestroy: function() {\r\n        if(this._updateListener)\r\n        {\r\n            cc.eventManager.removeListener(this._updateListener);\r\n            this._updateListener = null;\r\n        }\r\n        if(this._am && !cc.sys.ENABLE_GC_FOR_NATIVE_OBJECTS)\r\n        {\r\n            this._am.release();\r\n        }\r\n    }\r\n});\r\n"]}